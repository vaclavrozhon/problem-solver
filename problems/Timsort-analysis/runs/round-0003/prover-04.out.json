{
  "content": "## Scope and corrected target\nWe analyze Python\u2019s corrected TimSort (with the extra rule \u201c#5\u201d). The requested constant-1 bound comparisons \u2264 n\u00b7H + O(n) is false for TimSort; the right results are:\n- Coarse: comparisons = O(n + nH).\n- Sharp: comparisons \u2264 (3/2)\u00b7n\u00b7H + O(n), and the factor 3/2 is tight.\nGalloping is ignored (it only reduces comparisons), and detecting runs costs O(n).\n\n## Ideas: small, checkable lemmas\n\nLemma 1 (Stack growth invariant).\nAt any moment just before pushing a new run, we have r_1 < r_2, r_1 + r_2 < r_3, and for all i \u2265 3, r_i + r_{i+1} < r_{i+2}.\nWhy useful here: implies exponential growth along the stack.\n\nProof sketch. Routine case analysis of updates #1\u2013#5 shows each preserves these inequalities; pushing (#1) occurs only when all merging conditions fail (hence r_1 < r_2, r_1 + r_2 < r_3 and r_2 + r_3 < r_4), and #2\u2013#5 shift indices while retaining the strict \u201cFibonacci\u201d growth below the top.\n\nCorollary 2 (Geometric decay along stack).\nFor all i \u2264 j \u2264 h, r_i \u2264 2^{(i+1\u2212j)/2} r_j.\nWhy useful here: converts weighted starting-sequence sums to a constant\u00b7r bound.\n\nLemma 3 (Starting sequences cost \u2264 16.5\u00b7n).\nWhen a run R of size r is pushed and absorbed by k\u22121 merges #2 with underlying runs (k\u22652), the total cost C satisfies C \u2264 \u03b3 r with \u03b3 = 2 \u03a3_{j\u22651} j 2^{-j/2} = 2\u00b7x/(1\u2212x)^2 with x=2^{-1/2} = 16.485\u2026; summing over pushes gives total starting-sequence cost \u2264 16.5\u00b7n.\nWhy useful here: isolates a linear term; entropy term arises in ending sequences.\n\nProof. If the last #2 holds then r > r_k; by Cor. 2, r \u2265 r_k \u2265 2^{(k\u22121\u2212i)/2} r_i, so C/r \u2264 \u03a3_{i=1}^k (k+1\u2212i)\u00b72^{(i+1\u2212k)/2} = 2 \u03a3_{j=1}^k j\u00b72^{-j/2} < \u03b3.\n\nLemma 4 (Height after starting sequence).\nIf the just-pushed run has length r, the height h afterwards satisfies h \u2264 4 + 2 log2(n/r).\nWhy useful here: caps how many height decreases (and therefore token credits) any element can experience during the ending sequence.\n\nProof. From Lemma 1 and \u201cno more #2 now\u201d, r = r_1 \u2264 r_3 \u2264 2^{2\u2212h/2} n, hence h \u2264 4 + 2 log2(n/r).\n\nLemma 5 (Token amortization for ending sequences).\nCredit per element whenever its height decreases due to an ending-sequence merge: 2 C-tokens and 1 S-token. Spending: #2 spends 1 C on each of R_1,R_2; #3 spends 2 C on R_1; #4/#5 spend 1 C on R_1 and 1 S on R_2. Then balances never go negative in ending sequences.\nWhy useful here: shows ending-sequence merge-cost equals minted tokens, so we can bound by O(\u03a3 r (1+log(n/r))).\n\nProof. Each spend coincides with height decreases (thus credits) of the same elements: C-tokens cover all C-spends. For S-tokens: after #4/#5, the merged top becomes \u2265 second and top+second \u2265 third, forcing another merge in the same ending sequence (this is where #5 is used); thus the R_2-elements regain their S-token on the very next merge. Induct.\n\nLemma 6 (Ending sequence total cost).\nFor a run R of size r, by Lemma 4 each element\u2019s height can decrease in at most O(1 + log(n/r)) steps; with fixed per-step credits, the minted tokens per element are O(1 + log(n/r)), hence the ending-sequence cost for R is O(r (1 + log(n/r))). Summing over runs yields O(n + \u03a3 r_i log(n/r_i)) = O(n + nH).\n\nLemma 7 (Comparisons vs. merge-cost).\nCounting runs costs O(n) comparisons. Each merge of a,b uses \u2264 a+b\u22121 comparisons, hence total comparisons \u2264 (total merge-cost) \u2212 (\u03c1\u22121) + O(n) \u2264 (total merge-cost) + O(n).\n\nConclusion (coarse). By Lemma 3 + Lemma 6 + Lemma 7, TimSort performs O(n + nH) comparisons.\n\n## Towards the sharp constant 3/2 (succinct, testable pieces)\n\nPotential \u03a6(r) = (3/2) r log2 r.\n\nLemma 8 (Balanced merge criterion).\nIf two run sizes satisfy \u03c6^{\u22122} r \u2264 r\u2032 \u2264 \u03c6^{2} r, then cost(r,r\u2032) \u2264 \u0394\u03a6.\nWhy useful here: most merges in ending sequences are balanced and paid by potential.\n\nProof sketch. Let x = r/(r+r\u2032). Then \u0394\u03a6 = (3/2)(r+r\u2032) H(x). For x \u2208 [1/(1+\u03c6^2), 1\u22121/(1+\u03c6^2)], H(x) \u2265 H(1/(1+\u03c6^2)) \u2248 0.85 > 2/3, so \u0394\u03a6 > r+r\u2032.\n\nLemma 9 (Forbidden patterns in ending sequences).\nNo ending sequence contains #2#2, nor XX#2 (where X\u2208{#3,#4,#5}).\nWhy useful here: enables grouping of unbalanced merges into small groups whose combined cost is covered by potential.\n\nProof sketch. Both patterns force contradictory inequalities with Lemma 1 and Lemma 2; cf. AJNP (Fig. XX2) for a case-by-case contradiction.\n\nLemma 10 (Pairing unbalanced merges).\nIf a merge X of R_1,R_2 is too unbalanced (r_1 \u226a r_2), it is immediately followed by #3 (by Lemma 9); the two consecutive merges together satisfy cost \u2264 \u0394\u03a6(pair).\nWhy useful here: localizes unbalanced work into paid groups.\n\nLemma 11 (First-merge slack per ending sequence).\nThe first merge of an ending sequence may exceed its potential increase by at most r (length of the just-pushed run). Summing over all runs adds \u2264 n slack.\n\nConclusion (sharp). Summing \u0394\u03a6 over all merges telescopes to \u2212(3/2) \u03a3 r_i log2(r_i) = (3/2) n\u00b7H. With grouping (Lemmas 8\u201311) and +O(n) slack, total merge-cost \u2264 (3/2)\u00b7n\u00b7H + O(n), hence comparisons \u2264 (3/2)\u00b7n\u00b7H + O(n). Buss\u2013Knop\u2019s family shows \u2265 (3/2)\u00b7n\u00b7H \u2212 O(n): factor 3/2 is tight.\n\n## Examples / sanity checks\n- Small stack r=(5,7,11,17): #4 triggers (5+7\u226511), then #3 triggers next; S-token is reimbursed as claimed in Lemma 5.\n- Attempt to realize #2#2: inequalities force r_1+r_2 \u2265 r_5 and r_3+r_4 < r_5 with r_2<r_4; contradiction since r_1+r_2 < r_3+r_4 fails.\n\n## Obstacles\n- Lemma 5 relies on the extra #5 rule; without it, S-tokens can break (this matches the original Java bug). Our scope is Python\u2019s fixed TimSort.\n\n## Next steps\n- Move the detailed proofs of Lemmas 1\u20137 into proofs.md to finalize the O(n + nH) bound with explicit constant \u03b3 \u2248 16.49 for starting sequences.\n- Add concise proofs of Lemmas 8\u201311 (potential method) to complete the (3/2)\u00b7n\u00b7H + O(n) bound, and cite the Buss\u2013Knop lower bound family.\n- Keep output.md to the corrected main theorem and the coarse statement.\n"
}